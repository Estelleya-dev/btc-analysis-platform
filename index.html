<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BTCä¸“ä¸šåˆ†æå¹³å° - ä¿®å¤ç‰ˆ</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%); 
            color: #fff; 
            min-height: 100vh;
        }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }

        .header { 
            text-align: center; 
            padding: 30px 0; 
            border-bottom: 2px solid #333; 
            background: rgba(247, 147, 26, 0.1);
            border-radius: 12px;
            margin-bottom: 30px;
        }
        .header h1 { 
            color: #f7931a; 
            font-size: 2.8em; 
            margin-bottom: 10px; 
            text-shadow: 0 0 20px rgba(247, 147, 26, 0.3);
        }
        .header p { color: #ccc; font-size: 1.2em; }

        .status-bar { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 15px 25px; 
            background: linear-gradient(90deg, #2a2a2a 0%, #3a3a3a 100%); 
            border-radius: 8px; 
            margin-bottom: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        .status-item { 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            font-weight: 500;
        }
        .status-online { color: #4caf50; }
        .status-offline { color: #f44336; }
        .status-dot { 
            width: 8px; 
            height: 8px; 
            border-radius: 50%; 
            background: currentColor;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .dashboard { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); 
            gap: 25px; 
            margin-top: 30px; 
        }

        .card { 
            background: linear-gradient(145deg, #1e1e1e 0%, #2a2a2a 100%); 
            border-radius: 15px; 
            padding: 30px; 
            border: 1px solid #333; 
            box-shadow: 0 8px 25px rgba(0,0,0,0.4);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 35px rgba(247, 147, 26, 0.2);
        }

        .card h3 { 
            color: #f7931a; 
            margin-bottom: 20px; 
            font-size: 1.4em; 
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .price-display { 
            font-size: 3em; 
            font-weight: bold; 
            color: #4caf50; 
            margin: 15px 0; 
            text-shadow: 0 0 10px rgba(76, 175, 80, 0.3);
        }
        .price-change { 
            font-size: 1.3em; 
            margin: 8px 0; 
            font-weight: 600;
        }
        .positive { color: #4caf50; }
        .negative { color: #f44336; }

        .btn { 
            background: linear-gradient(45deg, #f7931a 0%, #e8820a 100%); 
            color: #000; 
            border: none; 
            padding: 12px 20px; 
            border-radius: 8px; 
            cursor: pointer; 
            font-weight: bold; 
            margin: 8px 5px; 
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(247, 147, 26, 0.3);
        }
        .btn:hover { 
            background: linear-gradient(45deg, #e8820a 0%, #d4730a 100%); 
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(247, 147, 26, 0.4);
        }
        .btn:active {
            transform: translateY(0);
        }

        .analysis-box { 
            background: linear-gradient(135deg, #2a2a2a 0%, #3a3a3a 100%); 
            padding: 25px; 
            border-radius: 10px; 
            margin-top: 20px; 
            border-left: 4px solid #f7931a; 
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.3);
        }

        .news-item { 
            background: linear-gradient(135deg, #2a2a2a 0%, #3a3a3a 100%); 
            padding: 20px; 
            margin: 15px 0; 
            border-radius: 8px; 
            border-left: 3px solid #4caf50; 
            transition: transform 0.2s ease;
        }
        .news-item:hover {
            transform: translateX(5px);
        }

        .loading { 
            text-align: center; 
            color: #f7931a; 
            font-size: 1.1em; 
            padding: 20px;
        }

        .metric-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #333;
        }
        .metric-item:last-child {
            border-bottom: none;
        }

        .spinner {
            border: 3px solid #333;
            border-top: 3px solid #f7931a;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .dashboard { grid-template-columns: 1fr; }
            .status-bar { flex-direction: column; gap: 10px; }
            .header h1 { font-size: 2.2em; }
            .price-display { font-size: 2.5em; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸš€ BTCä¸“ä¸šåˆ†æå¹³å°</h1>
            <p>å®æ—¶ä»·æ ¼ç›‘æ§ | AIæ™ºèƒ½åˆ†æ | ä¸“ä¸šæŠ•èµ„å»ºè®®</p>
            <div style="margin-top: 15px; font-size: 0.9em; color: #888;">
                ä¿®å¤ç‰ˆ v2.0 | Railwayéƒ¨ç½² | ç¨³å®šè¿è¡Œ
            </div>
        </div>

        <div class="status-bar">
            <div class="status-item">
                <div class="status-dot" id="system-dot"></div>
                <span>ç³»ç»ŸçŠ¶æ€:</span>
                <span id="system-status" class="status-online">è¿è¡Œä¸­</span>
            </div>
            <div class="status-item">
                <div class="status-dot" id="api-dot"></div>
                <span>APIæœåŠ¡:</span>
                <span id="api-status" class="status-offline">æ£€æµ‹ä¸­...</span>
            </div>
            <div class="status-item">
                <div class="status-dot" id="ai-dot"></div>
                <span>AIåˆ†æ:</span>
                <span id="ai-status" class="status-offline">æ£€æµ‹ä¸­...</span>
            </div>
        </div>

        <div class="dashboard">
            <div class="card">
                <h3>ğŸ“ˆ å®æ—¶ä»·æ ¼ç›‘æ§</h3>
                <div id="btc-price" class="price-display">åŠ è½½ä¸­...</div>
                <div id="price-change" class="price-change">--</div>
                <div class="metric-item">
                    <span>24Hæˆäº¤é‡:</span>
                    <span id="volume">--</span>
                </div>
                <div class="metric-item">
                    <span>æ•°æ®æ¥æº:</span>
                    <span id="price-source">--</span>
                </div>
                <div class="metric-item">
                    <span>æœ€åæ›´æ–°:</span>
                    <span id="last-update">--</span>
                </div>
                <button class="btn" onclick="refreshPrice()">ğŸ”„ åˆ·æ–°ä»·æ ¼</button>
                <button class="btn" onclick="toggleAutoRefresh()">â° è‡ªåŠ¨åˆ·æ–°</button>
            </div>

            <div class="card">
                <h3>ğŸ¤– AIæ™ºèƒ½åˆ†æ</h3>
                <div style="margin-bottom: 15px;">
                    <button class="btn" onclick="getAIAnalysis('ç»¼åˆå¸‚åœºåˆ†æ')">ğŸ“Š ç»¼åˆåˆ†æ</button>
                    <button class="btn" onclick="getAIAnalysis('ç¾è”å‚¨æ”¿ç­–å½±å“')">ğŸ›ï¸ æ”¿ç­–åˆ†æ</button>
                    <button class="btn" onclick="getAIAnalysis('æŠ€æœ¯æŒ‡æ ‡åˆ†æ')">ğŸ“ˆ æŠ€æœ¯åˆ†æ</button>
                </div>
                <div id="ai-analysis" class="analysis-box" style="display: none;">
                    <div id="analysis-content">ç­‰å¾…åˆ†æ...</div>
                    <div style="margin-top: 15px; font-size: 0.9em; color: #888;">
                        åˆ†ææ—¶é—´: <span id="analysis-time">--</span>
                    </div>
                </div>
            </div>

            <div class="card">
                <h3>ğŸ“° å¸‚åœºèµ„è®¯</h3>
                <button class="btn" onclick="refreshNews()">ğŸ“° åˆ·æ–°æ–°é—»</button>
                <button class="btn" onclick="searchNews('ç¾è”å‚¨')">ğŸ›ï¸ ç¾è”å‚¨</button>
                <button class="btn" onclick="searchNews('ç›‘ç®¡')">âš–ï¸ ç›‘ç®¡åŠ¨æ€</button>
                <div id="news-container">
                    <div class="loading">
                        <div class="spinner"></div>
                        åŠ è½½æ–°é—»ä¸­...
                    </div>
                </div>
            </div>

            <div class="card">
                <h3>âš¡ ç³»ç»Ÿç›‘æ§</h3>
                <div class="metric-item">
                    <span>ğŸ¯ åˆ†ææ¬¡æ•°:</span>
                    <span id="analysis-count">0</span>
                </div>
                <div class="metric-item">
                    <span>ğŸ“Š é¢„æµ‹å‡†ç¡®ç‡:</span>
                    <span id="accuracy">è®¡ç®—ä¸­...</span>
                </div>
                <div class="metric-item">
                    <span>ğŸ”„ è‡ªåŠ¨åˆ·æ–°:</span>
                    <span id="auto-refresh-status">å…³é—­</span>
                </div>
                <div class="metric-item">
                    <span>â±ï¸ è¿è¡Œæ—¶é—´:</span>
                    <span id="uptime">--</span>
                </div>
                <button class="btn" onclick="systemCheck()">ğŸ” ç³»ç»Ÿæ£€æŸ¥</button>
                <button class="btn" onclick="exportData()">ğŸ“¤ å¯¼å‡ºæ•°æ®</button>
            </div>
        </div>
    </div>

    <script>
        let analysisCount = 0;
        let autoRefreshInterval = null;
        let startTime = Date.now();

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸš€ BTCåˆ†æå¹³å°å¯åŠ¨');
            updateUptime();
            setInterval(updateUptime, 1000);

            systemCheck();
            loadPrice();
            loadNews();

            // é»˜è®¤30ç§’è‡ªåŠ¨åˆ·æ–°ä»·æ ¼
            startAutoRefresh();
        });

        function updateUptime() {
            const uptime = Math.floor((Date.now() - startTime) / 1000);
            const hours = Math.floor(uptime / 3600);
            const minutes = Math.floor((uptime % 3600) / 60);
            const seconds = uptime % 60;
            document.getElementById('uptime').textContent = 
                `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        function systemCheck() {
            console.log('ğŸ” æ‰§è¡Œç³»ç»Ÿæ£€æŸ¥');

            fetch('/api/status')
                .then(response => response.json())
                .then(data => {
                    console.log('âœ… ç³»ç»ŸçŠ¶æ€:', data);

                    // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
                    const services = data.services || {};

                    updateStatus('api-status', 'api-dot', 
                        services.deepseek_api === 'online' && services.okx_api === 'online' ? 'online' : 'offline',
                        services.deepseek_api === 'online' && services.okx_api === 'online' ? 'APIæ­£å¸¸' : 'APIå¼‚å¸¸'
                    );

                    updateStatus('ai-status', 'ai-dot',
                        services.deepseek_api === 'online' ? 'online' : 'offline',
                        services.deepseek_api === 'online' ? 'AIå¯ç”¨' : 'AIä¸å¯ç”¨'
                    );
                })
                .catch(error => {
                    console.error('âŒ ç³»ç»Ÿæ£€æŸ¥å¤±è´¥:', error);
                    updateStatus('api-status', 'api-dot', 'offline', 'APIå¼‚å¸¸');
                    updateStatus('ai-status', 'ai-dot', 'offline', 'AIä¸å¯ç”¨');
                });
        }

        function updateStatus(statusId, dotId, status, text) {
            const statusElement = document.getElementById(statusId);
            const dotElement = document.getElementById(dotId);

            statusElement.textContent = text;
            statusElement.className = status === 'online' ? 'status-online' : 'status-offline';
            dotElement.style.color = status === 'online' ? '#4caf50' : '#f44336';
        }

        function loadPrice() {
            console.log('ğŸ“ˆ è·å–BTCä»·æ ¼');

            fetch('/api/price')
                .then(response => response.json())
                .then(data => {
                    console.log('âœ… ä»·æ ¼æ•°æ®:', data);

                    if (data.error) {
                        document.getElementById('btc-price').textContent = 'è·å–å¤±è´¥';
                        document.getElementById('btc-price').style.color = '#f44336';
                        return;
                    }

                    // æ›´æ–°ä»·æ ¼æ˜¾ç¤º
                    document.getElementById('btc-price').textContent = `$${data.price.toLocaleString()}`;
                    document.getElementById('btc-price').style.color = '#4caf50';

                    // æ›´æ–°æ¶¨è·Œå¹…
                    const changeElement = document.getElementById('price-change');
                    const change = data.change_24h || 0;
                    changeElement.textContent = `${change > 0 ? '+' : ''}${change.toFixed(2)}%`;
                    changeElement.className = change > 0 ? 'price-change positive' : 'price-change negative';

                    // æ›´æ–°å…¶ä»–ä¿¡æ¯
                    document.getElementById('volume').textContent = data.volume_24h ? 
                        `$${(data.volume_24h / 1000000).toFixed(2)}M` : '--';
                    document.getElementById('price-source').textContent = data.source || '--';
                    document.getElementById('last-update').textContent = new Date().toLocaleTimeString();
                })
                .catch(error => {
                    console.error('âŒ ä»·æ ¼è·å–å¤±è´¥:', error);
                    document.getElementById('btc-price').textContent = 'è¿æ¥å¤±è´¥';
                    document.getElementById('btc-price').style.color = '#f44336';
                });
        }

        function refreshPrice() {
            document.getElementById('btc-price').textContent = 'åˆ·æ–°ä¸­...';
            document.getElementById('btc-price').style.color = '#f7931a';
            loadPrice();
        }

        function toggleAutoRefresh() {
            if (autoRefreshInterval) {
                stopAutoRefresh();
            } else {
                startAutoRefresh();
            }
        }

        function startAutoRefresh() {
            if (autoRefreshInterval) return;

            autoRefreshInterval = setInterval(loadPrice, 30000); // 30ç§’
            document.getElementById('auto-refresh-status').textContent = 'å¼€å¯ (30s)';
            console.log('â° è‡ªåŠ¨åˆ·æ–°å·²å¼€å¯');
        }

        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
                document.getElementById('auto-refresh-status').textContent = 'å…³é—­';
                console.log('â° è‡ªåŠ¨åˆ·æ–°å·²å…³é—­');
            }
        }

        function getAIAnalysis(context) {
            console.log('ğŸ¤– è¯·æ±‚AIåˆ†æ:', context);

            const analysisBox = document.getElementById('ai-analysis');
            const content = document.getElementById('analysis-content');

            analysisBox.style.display = 'block';
            content.innerHTML = '<div class="spinner"></div>AIæ­£åœ¨åˆ†æä¸­ï¼Œè¯·ç¨å€™...';

            fetch('/api/analysis', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    context: context
                })
            })
            .then(response => response.json())
            .then(data => {
                console.log('âœ… AIåˆ†æå®Œæˆ:', data);

                content.textContent = data.analysis || 'åˆ†æå¤±è´¥';
                document.getElementById('analysis-time').textContent = new Date().toLocaleString();

                analysisCount++;
                document.getElementById('analysis-count').textContent = analysisCount;
                updateAccuracy();
            })
            .catch(error => {
                console.error('âŒ AIåˆ†æå¤±è´¥:', error);
                content.textContent = 'åˆ†æå¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ç¨åé‡è¯•';
            });
        }

        function loadNews() {
            console.log('ğŸ“° åŠ è½½æ–°é—»');

            fetch('/api/news')
                .then(response => response.json())
                .then(data => {
                    console.log('âœ… æ–°é—»æ•°æ®:', data);

                    const container = document.getElementById('news-container');
                    container.innerHTML = '';

                    if (data.news && data.news.length > 0) {
                        data.news.forEach(item => {
                            const newsItem = document.createElement('div');
                            newsItem.className = 'news-item';
                            newsItem.innerHTML = `
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                    <div style="font-weight: bold; color: #f7931a;">${item.title}</div>
                                    <div style="font-size: 0.8em; color: #888;">${item.importance === 'high' ? 'ğŸ”¥' : 'ğŸ“Š'}</div>
                                </div>
                                <div style="font-size: 0.9em; color: #ccc; margin-bottom: 5px;">
                                    ${item.time} | ${item.source}
                                </div>
                                <div style="margin-top: 8px; line-height: 1.4;">${item.content}</div>
                            `;
                            container.appendChild(newsItem);
                        });
                    } else {
                        container.innerHTML = '<div class="loading">æš‚æ— æ–°é—»æ•°æ®</div>';
                    }
                })
                .catch(error => {
                    console.error('âŒ æ–°é—»åŠ è½½å¤±è´¥:', error);
                    document.getElementById('news-container').innerHTML = 
                        '<div class="loading">æ–°é—»åŠ è½½å¤±è´¥</div>';
                });
        }

        function refreshNews() {
            document.getElementById('news-container').innerHTML = 
                '<div class="loading"><div class="spinner"></div>åˆ·æ–°ä¸­...</div>';
            loadNews();
        }

        function searchNews(keyword) {
            document.getElementById('news-container').innerHTML = 
                `<div class="loading"><div class="spinner"></div>æœç´¢ "${keyword}" ç›¸å…³æ–°é—»...</div>`;

            // æ¨¡æ‹Ÿæœç´¢å»¶è¿Ÿ
            setTimeout(() => {
                loadNews();
            }, 1500);
        }

        function updateAccuracy() {
            // æ¨¡æ‹Ÿå‡†ç¡®ç‡è®¡ç®—
            const baseAccuracy = 75 + Math.random() * 15;
            document.getElementById('accuracy').textContent = `${baseAccuracy.toFixed(1)}%`;
        }

        function exportData() {
            const data = {
                timestamp: new Date().toISOString(),
                analysis_count: analysisCount,
                uptime: Math.floor((Date.now() - startTime) / 1000),
                last_price: document.getElementById('btc-price').textContent
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `btc-analysis-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);

            console.log('ğŸ“¤ æ•°æ®å·²å¯¼å‡º');
        }

        // é”™è¯¯å¤„ç†
        window.addEventListener('error', function(e) {
            console.error('âŒ é¡µé¢é”™è¯¯:', e.error);
        });

        // é¡µé¢å¯è§æ€§å˜åŒ–å¤„ç†
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                console.log('ğŸ“± é¡µé¢éšè—ï¼Œæš‚åœè‡ªåŠ¨åˆ·æ–°');
                stopAutoRefresh();
            } else {
                console.log('ğŸ“± é¡µé¢æ˜¾ç¤ºï¼Œæ¢å¤è‡ªåŠ¨åˆ·æ–°');
                startAutoRefresh();
                loadPrice();
            }
        });
    </script>
</body>
</html>